<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Finalizar Compra</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f8fafc;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .checkout-container {
            background: white;
            width: 800px;
            display: flex;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* SECCIÓN IZQUIERDA: RESUMEN */
        .summary-panel {
            background-color: #1e293b;
            color: white;
            padding: 40px;
            width: 40%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .plan-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #60a5fa;
        }

        .total-label {
            font-size: 14px;
            color: #94a3b8;
            margin-top: 30px;
        }

        .total-price {
            font-size: 40px;
            font-weight: 800;
        }

        .features-mini {
            margin-top: 20px;
            font-size: 14px;
            color: #cbd5e1;
            line-height: 1.6;
        }

        /* SECCIÓN DERECHA: FORMULARIO */
        .payment-panel {
            padding: 40px;
            width: 60%;
        }

        h2 {
            margin: 0 0 20px 0;
            color: #334155;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #64748b;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border 0.3s;
        }

        input:focus {
            border-color: #3b82f6;
            outline: none;
        }

        .row {
            display: flex;
            gap: 15px;
        }

        .col {
            flex: 1;
        }

        .btn-pay {
            width: 100%;
            padding: 15px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .btn-pay:hover {
            background-color: #2563eb;
        }

        .secure-badge {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #94a3b8;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:src="@{/main.js}"></script>
    <script>
        function simularPago(event) {
            event.preventDefault();
            const btn = document.querySelector('.btn-pay');

            // Recoger datos del DOM
            const plan = document.querySelector('.plan-name').innerText.trim();
            const precio = document.querySelector('.total-price span').innerText.trim();

            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Verificando Bizum...';
            btn.disabled = true;

            setTimeout(async () => {

                try {
                    const response = await fetch('/web/pago/procesar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ plan: plan, precio: precio })
                    });

                    if (response.ok) {
                        if (typeof window.Toast !== 'undefined') {
                            window.Toast.fire({
                                icon: 'success',
                                title: '¡Pago Confirmado!',
                                text: 'Tu suscripción al ' + plan + ' está activa.'
                            });
                            // Redirect after short delay
                            setTimeout(() => {
                                window.location.href = '/web/planes';
                            }, 2000);
                        } else {
                            Swal.fire({
                                title: '¡Pago Confirmado!',
                                text: 'Tu suscripción al ' + plan + ' está activa.',
                                icon: 'success'
                            }).then(() => {
                                window.location.href = '/web/planes';
                            });
                        }
                    } else {
                        if (window.Toast) window.Toast.fire({ icon: 'error', title: 'Error', text: 'Error procesando el pago.' });
                        else Swal.fire('Error', 'Hubo un problema procesando el pago. Inténtalo de nuevo.', 'error');

                        btn.innerHTML = '<i class="fa-solid fa-check-circle"></i> Confirmar envío de Bizum';
                        btn.disabled = false;
                    }

                } catch (e) {
                    if (window.Toast) window.Toast.fire({ icon: 'error', title: 'Error', text: 'Error de conexión.' });
                    else Swal.fire('Error', 'Error de conexión.', 'error');

                    btn.innerHTML = '<i class="fa-solid fa-check-circle"></i> Confirmar envío de Bizum';
                    btn.disabled = false;
                }

            }, 2000); // 2 segundos de "verificación"
        }
    </script>
</head>

<body>

    <div class="checkout-container">

        <div class="summary-panel">
            <p style="margin: 0; color: #94a3b8; text-transform: uppercase; font-size: 12px;">Estás contratando</p>

            <div class="plan-name" th:text="${planSeleccionado}">Cargando plan...</div>

            <div class="features-mini">
                <i class="fa-solid fa-check"></i> Renovación mensual<br>
                <i class="fa-solid fa-check"></i> Cancela cuando quieras
            </div>

            <div class="total-label">TOTAL A PAGAR</div>
            <div class="total-price">
                <span th:text="${precioSeleccionado}">0.00</span>€
            </div>
        </div>

        <div class="payment-panel">
            <h2 style="text-align: center; color: #1e293b;">Pago Mediante Bizum</h2>

            <div
                style="display: flex; flex-direction: column; align-items: center; text-align: center; margin-top: 20px;">

                <div
                    style="background: #00ea90; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; margin-bottom: 15px; font-weight: bold;">
                    B
                </div>

                <p style="color: #64748b; font-size: 16px; margin-bottom: 25px; line-height: 1.5;">
                    Para completar la contratación del plan <strong th:text="${planSeleccionado}"></strong>, por favor
                    realiza un envío de dinero inmediato.
                </p>

                <div
                    style="background-color: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 15px; padding: 25px; width: 100%; box-sizing: border-box; margin-bottom: 25px;">
                    <div style="font-size: 12px; text-transform: uppercase; color: #94a3b8; font-weight: bold;">Número
                        de teléfono</div>
                    <div
                        style="font-size: 32px; font-weight: 800; color: #0f172a; margin: 10px 0; letter-spacing: 1px;">
                        +34 695 84 23 11
                    </div>
                    <div style="font-size: 14px; color: #64748b;">
                        Titular: <strong>ServiClick Pagos</strong>
                    </div>
                    <div
                        style="margin-top: 15px; font-size: 14px; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 10px;">
                        Concepto: <strong>Alta <span th:text="${planSeleccionado}"></span></strong>
                    </div>
                </div>

                <button onclick="simularPago(event)" class="btn-pay" style="background-color: #00ea90; color: #064e3b;">
                    <i class="fa-solid fa-check-circle"></i> Confirmar envío de Bizum
                </button>

                <div style="margin-top: 20px; font-size: 13px; color: #94a3b8;">
                    <i class="fa-solid fa-stopwatch"></i> El sistema verificará el pago automáticamente en unos
                    segundos.
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <a th:href="@{/web/planes}" style="color: #64748b; text-decoration: none; font-size: 14px;">Cancelar
                        operación</a>
                </div>

            </div>
        </div>
    </div>

</body>

</html>