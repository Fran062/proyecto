<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServiClick - Mi Perfil</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/style.css}">
</head>

<body>
    <header>
        <nav>
            <a th:href="@{/}" class="logo"><i class="fas fa-handshake"></i> ServiClick</a>
            <div class="nav-links">
                <a th:href="@{/}">Inicio</a>
                <a th:href="@{/web/servicios}">Buscar Servicios</a>

                <a th:href="@{/web/publicar}"
                    th:if="${session.usuarioLogueado != null and (session.usuarioLogueado.rol.toString() == 'PROFESIONAL' or session.usuarioLogueado.rol.toString() == 'ADMIN')}">Publicar
                    Servicio</a>

                <a th:href="@{/web/planes}"
                    th:if="${session.usuarioLogueado == null or (session.usuarioLogueado != null and (session.usuarioLogueado.rol.toString() == 'CLIENTE' or session.usuarioLogueado.rol.toString() == 'ADMIN'))}">Ver
                    Planes</a>
            </div>
            <div class="auth-buttons flex-center" th:if="${session.usuarioLogueado == null}">
                <a th:href="@{/login}" class="btn-primary">Iniciar Sesión <i
                        class="fa-solid fa-arrow-right-to-bracket"></i></a>
            </div>
            <div class="auth-buttons" th:if="${session.usuarioLogueado != null}">
                <a th:href="@{/web/perfil}"
                    style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: #1e293b;">
                    <div
                        style="width: 40px; height: 40px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        <span th:text="${#strings.substring(session.usuarioLogueado.nombreCompleto, 0, 1)}">U</span>
                    </div>
                </a>
            </div>
        </nav>
    </header>

    <main>
        <div style="max-width: 800px; margin: 0 auto;">
            <!-- Panel de Administración (Solo ADMIN) -->
            <div th:if="${usuario.rol == 'ADMIN'}" style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem; border-left: 5px solid #ef4444;">
                <h2 style="margin-bottom: 1.5rem; color: #ef4444;"><i class="fas fa-user-shield"></i> Panel de Administración</h2>

                <!-- Mensajes de Error/Éxito Admin -->
                <div th:if="${errorBusqueda}" style="background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-circle"></i> <span th:text="${errorBusqueda}">Error</span>
                </div>
                <div th:if="${errorBorrado}" style="background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-circle"></i> <span th:text="${errorBorrado}">Error</span>
                </div>
                <div th:if="${mensajeExitoAdmin}" style="background-color: #dcfce7; color: #15803d; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i> <span th:text="${mensajeExitoAdmin}">Éxito</span>
                </div>

                <!-- Formulario de Búsqueda -->
                <form th:action="@{/web/admin/buscar-usuario-borrar}" method="post" style="margin-bottom: 2rem;">
                    <div class="form-group">
                        <label style="color: #374151; font-weight: 600;">Buscar usuario para eliminar (por correo)</label>
                        <div style="display: flex; gap: 10px; margin-top: 0.5rem;">
                            <input type="email" name="emailBusqueda" placeholder="usuario@ejemplo.com" required style="flex: 1;">
                            <button type="submit" class="btn-primary" style="background-color: #ef4444; border-color: #ef4444;">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Confirmación de Borrado -->
                <div th:if="${usuarioParaBorrar != null}" style="background-color: #fff1f2; border: 1px solid #fecaca; padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: #991b1b; margin-bottom: 1rem;">¿Estás seguro de que deseas eliminar este usuario?</h3>
                    <div style="margin-bottom: 1.5rem;">
                        <p><strong>Nombre:</strong> <span th:text="${usuarioParaBorrar.nombreCompleto}">Nombre</span></p>
                        <p><strong>Correo:</strong> <span th:text="${usuarioParaBorrar.correo}">Correo</span></p>
                        <p><strong>Rol:</strong> <span th:text="${usuarioParaBorrar.rol}">Rol</span></p>
                    </div>

                    <form th:action="@{/web/admin/borrar-usuario-confirmado}" method="post">
                        <input type="hidden" name="idUsuarioParaBorrar" th:value="${usuarioParaBorrar.id}">
                        <div class="form-group">
                            <label style="color: #7f1d1d;">Escribe "borrar" para confirmar:</label>
                            <input type="text" name="confirmacion" placeholder="borrar" required
                                style="border-color: #fca5a5; margin-top: 0.5rem;">
                        </div>
                        <div style="text-align: right; margin-top: 1rem;">
                            <a th:href="@{/web/perfil}" class="btn-outline" style="margin-right: 10px; border-color: #991b1b; color: #991b1b;">Cancelar</a>
                            <button type="submit" class="btn-danger">Confirmar Eliminación</button>
                        </div>
                    </form>
                </div>
            </div>

            <h1 style="margin-bottom: 2rem;">Ajustes de Cuenta</h1>

            <div
                style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem;">
                <div
                    style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1.5rem;">
                    <div
                        style="width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h2 style="margin-bottom: 0.2rem;">Mi Cuenta</h2>
                        <p style="color: var(--text-gray);">Gestiona tus datos personales y seguridad.</p>
                    </div>
                </div>

                <form th:action="@{/web/perfil/guardar}" method="post" th:object="${usuario}">
                    <input type="hidden" th:field="*{id}">
                    <div class="form-row"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Nombre Completo</label>
                            <input type="text" th:field="*{nombreCompleto}" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono</label>
                            <input type="tel" th:field="*{telefono}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Correo Electrónico</label>
                        <input type="email" th:field="*{correo}" required readonly
                            style="background-color: #f3f4f6; cursor: not-allowed;">
                        <small style="color: #6b7280;">El correo no se puede cambiar.</small>
                    </div>

                    <div class="form-group">
                        <label>Nueva Contraseña (Dejar en blanco para mantener)</label>
                        <input type="password" name="nuevaPassword" placeholder="********">
                    </div>

                    <div style="text-align: right; margin-top: 1.5rem;">
                        <button type="submit" class="btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>

            <div
                style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1rem;"><i class="fas fa-crown" style="color: #f59e0b;"></i> Tu Suscripción
                </h2>
                <div th:if="${usuario.suscripcion != null and usuario.suscripcion.activa}">
                    <h3 style="color: #3b82f6; font-size: 1.5rem; margin-bottom: 0.5rem;"
                        th:text="${usuario.suscripcion.nombrePlan}">Plan</h3>
                    <p style="color: #64748b; margin-bottom: 1rem;">
                        Precio: <strong th:text="${usuario.suscripcion.precioTotalMensual}">0.00</strong>€/mes
                    </p>
                    <a th:href="@{/web/planes}" class="btn-outline">Cambiar de Plan</a>
                </div>
                <div th:if="${usuario.suscripcion == null or !usuario.suscripcion.activa}">
                    <p style="color: #64748b; margin-bottom: 1rem;">No tienes un plan activo actualmente. Contrata uno
                        para disfrutar de ventajas exclusivas.</p>
                    <a th:href="@{/web/planes}" class="btn-primary">Ver Planes Disponibles</a>
                </div>
            </div>

            <div
                style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1rem;"><i class="fas fa-file-invoice" style="color: #6366f1;"></i> Facturación
                    e Historial</h2>
                <p style="color: #64748b; margin-bottom: 1rem;">Descarga un informe detallado con tus servicios
                    contratados y plan activo.</p>
                <a th:href="@{'http://localhost:8080/api/reportes/factura/' + ${session.usuarioLogueado.id}}"
                    target="_blank" class="btn-primary"
                    style="display:inline-flex; align-items:center; gap:8px; text-decoration:none;">
                    <i class="fas fa-file-pdf"></i> Descargar Factura Completa
                </a>
            </div>

            <div style="background: #fef2f2; padding: 1.5rem; border-radius: 12px; border: 1px solid #fee2e2;">
                <h3 style="color: #991b1b; margin-bottom: 0.5rem;">Zona de Sesión</h3>
                <p style="color: #b91c1c; margin-bottom: 1rem; font-size: 0.9rem;">
                    Si cierras sesión tendrás que volver a introducir tus credenciales para acceder.
                </p>
                <a th:href="@{/logout}" class="btn-danger"
                    style="display: inline-block; text-decoration: none; text-align: center;">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </a>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const telefonoInput = document.querySelector('input[name="telefono"]');
        if (telefonoInput) {
            telefonoInput.addEventListener('input', function (e) {
                // Remove non-numeric chars
                let value = e.target.value.replace(/\D/g, '');
                // Check if starts with 34 (Spain code)
                if (value.startsWith('34')) {
                    // value is ok
                }
            });

            // HTML5 validation handling
            telefonoInput.setAttribute('pattern', '(\\+34|0034|34)?[6789]\\d{8}');
            telefonoInput.setAttribute('title', 'Introduce un número español válido (empieza por 6, 7, 8, 9, con 9 dígitos)');

            telefonoInput.addEventListener('invalid', function (e) {
                e.target.setCustomValidity('Por favor, introduce un número de teléfono móvil o fijo español válido.');
            });
            telefonoInput.addEventListener('input', function (e) {
                e.target.setCustomValidity('');
            });
        }

        // Check for URI param 'exito'
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('exito')) {
            if (typeof window.Toast !== 'undefined') {
                window.Toast.fire({
                    icon: 'success',
                    title: 'Guardado',
                    text: 'Tu perfil se ha actualizado correctamente.'
                });
            } else {
                Swal.fire({
                    title: '¡Guardado!',
                    text: 'Tu perfil se ha actualizado correctamente.',
                    icon: 'success',
                    confirmButtonColor: '#3b82f6'
                });
            }
            // Clean URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>

    <footer>
        <p>&copy; 2025 ServClicks</p>
    </footer>

    <script th:src="@{/main.js}"></script>
</body>

</html>